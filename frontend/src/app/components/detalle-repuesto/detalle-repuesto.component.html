<div *ngIf="cargando" style="text-align:center;padding:60px">
  <mat-spinner diameter="40" style="margin:auto"></mat-spinner>
</div>

<div *ngIf="repuesto && !cargando">
  <button mat-button routerLink="/catalogo" style="margin-bottom:16px">
    <mat-icon>arrow_back</mat-icon> Volver al catálogo
  </button>

  <div class="detalle-container">
    <div>
      <img class="detalle-img"
           [src]="repuesto.imagenUrl || 'assets/repuesto-default.png'"
           [alt]="repuesto.nombre"
           onerror="this.src='assets/repuesto-default.png'">
    </div>

    <div>
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <h1 style="font-size:1.8em;margin-bottom:8px">{{ repuesto.nombre }}</h1>
        <button mat-icon-button [color]="esFavorito ? 'warn' : ''"
                (click)="toggleFavorito()"
                [matTooltip]="esFavorito ? 'Quitar de favoritos' : 'Agregar a favoritos'">
          <mat-icon>{{ esFavorito ? 'favorite' : 'favorite_border' }}</mat-icon>
        </button>
      </div>
      <p style="color:#888">Código: {{ repuesto.codigo }}</p>

      <div class="precio-grande">${{ repuesto.precio | number:'1.2-2' }}</div>

      <div class="info-row">
        <strong>Marca:</strong> {{ repuesto.marca?.nombre }}
        <span *ngIf="repuesto.marca?.paisOrigen"> ({{ repuesto.marca?.paisOrigen }})</span>
      </div>
      <div class="info-row" *ngIf="repuesto.modelo">
        <strong>Modelo:</strong> {{ repuesto.modelo?.nombre }}
        <span *ngIf="repuesto.modelo?.anioInicio">
          ({{ repuesto.modelo?.anioInicio }} - {{ repuesto.modelo?.anioFin || 'actual' }})
        </span>
      </div>
      <div class="info-row" *ngIf="repuesto.categoria">
        <strong>Categoría:</strong> {{ repuesto.categoria?.nombre }}
      </div>
      <div class="info-row">
        <strong>Disponibilidad:</strong>
        <span [class.stock-ok]="repuesto.stock > 5"
              [class.stock-bajo]="repuesto.stock > 0 && repuesto.stock <= 5"
              [class.stock-agotado]="repuesto.stock === 0">
          {{ repuesto.stock > 0 ? repuesto.stock + ' unidades en stock' : 'Agotado' }}
        </span>
      </div>

      <mat-divider style="margin:16px 0"></mat-divider>

      <p *ngIf="repuesto.descripcion" style="color:#555;line-height:1.6">
        {{ repuesto.descripcion }}
      </p>

      <div style="display:flex;align-items:center;gap:16px;margin-top:20px">
        <mat-form-field style="width:80px">
          <mat-label>Cant.</mat-label>
          <input matInput type="number" [(ngModel)]="cantidad"
                 [min]="1" [max]="repuesto.stock">
        </mat-form-field>

        <button mat-raised-button color="primary" style="height:50px"
                [disabled]="repuesto.stock === 0"
                (click)="agregarAlCarrito()">
          <mat-icon>add_shopping_cart</mat-icon>
          Agregar al carrito
        </button>
      </div>
    </div>
  </div>

  <!-- Repuestos relacionados -->
  <div *ngIf="relacionados.length > 0" style="margin-top:40px">
    <h2 style="color:#1565C0;margin-bottom:4px">Repuestos relacionados</h2>
    <mat-divider style="margin-bottom:16px"></mat-divider>
    <div class="relacionados-grid">
      <mat-card *ngFor="let r of relacionados" class="relacionado-card"
                [routerLink]="['/repuesto', r.id]">
        <img mat-card-image
             [src]="r.imagenUrl || 'assets/repuesto-default.png'"
             [alt]="r.nombre"
             style="height:120px;object-fit:contain;padding:8px"
             onerror="this.src='assets/repuesto-default.png'">
        <mat-card-content style="padding:8px">
          <p style="font-weight:600;font-size:.9em;margin-bottom:4px">{{ r.nombre }}</p>
          <p class="precio-tag" style="font-size:1em">${{ r.precio | number:'1.2-2' }}</p>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
