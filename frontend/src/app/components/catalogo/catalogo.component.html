<div class="catalog-header">
  <h1>Catálogo de Repuestos</h1>
</div>

<!-- Filtros -->
<form [formGroup]="filtroForm" (ngSubmit)="buscar()" class="filtros">
  <mat-form-field class="filtro-field">
    <mat-label>Buscar por nombre</mat-label>
    <input matInput formControlName="nombre" placeholder="Ej: filtro de aceite">
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>

  <mat-form-field class="filtro-field">
    <mat-label>Marca</mat-label>
    <mat-select formControlName="marcaId">
      <mat-option [value]="null">Todas</mat-option>
      <mat-option *ngFor="let m of marcas" [value]="m.id">{{ m.nombre }}</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field class="filtro-field">
    <mat-label>Modelo</mat-label>
    <mat-select formControlName="modeloId" [disabled]="!filtroForm.value.marcaId">
      <mat-option [value]="null">Todos</mat-option>
      <mat-option *ngFor="let m of modelos" [value]="m.id">{{ m.nombre }}</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field class="filtro-field">
    <mat-label>Categoría</mat-label>
    <mat-select formControlName="categoriaId">
      <mat-option [value]="null">Todas</mat-option>
      <mat-option *ngFor="let c of categorias" [value]="c.id">{{ c.nombre }}</mat-option>
    </mat-select>
  </mat-form-field>

  <button mat-raised-button color="primary" type="submit">
    <mat-icon>search</mat-icon> Buscar
  </button>
  <button mat-stroked-button type="button" (click)="limpiarFiltros()">
    <mat-icon>clear</mat-icon> Limpiar
  </button>
</form>

<!-- Cargando -->
<div *ngIf="cargando" style="text-align:center;padding:60px">
  <mat-spinner diameter="44" style="margin:auto"></mat-spinner>
</div>

<!-- Sin resultados -->
<div *ngIf="!cargando && repuestos.length === 0" class="no-results">
  <mat-icon style="font-size:56px;width:56px;height:56px;color:#cbd5e1">search_off</mat-icon>
  <h2>Sin resultados</h2>
  <p>No se encontraron repuestos con los filtros seleccionados.</p>
</div>

<!-- Grid de productos -->
<div class="productos-grid" *ngIf="!cargando">
  <mat-card *ngFor="let r of repuestos" class="producto-card" routerLink="/repuesto/{{r.id}}">

    <mat-card-header>
      <mat-card-title>{{ r.nombre }}</mat-card-title>
      <mat-card-subtitle>
        <span class="marca-chip">{{ r.marca?.nombre }}</span>
        <span *ngIf="r.modelo" style="color:#94a3b8;font-size:.8rem"> · {{ r.modelo?.nombre }}</span>
        <span *ngIf="r.categoria"> &nbsp;<span class="categoria-chip">{{ r.categoria?.nombre }}</span></span>
      </mat-card-subtitle>
    </mat-card-header>

    <!-- Imagen con botón favorito flotando sobre ella -->
    <div class="card-img-wrap">
      <div class="card-img-inner">
        <img [src]="r.imagenUrl || 'assets/repuesto-default.png'"
             [alt]="r.nombre"
             onerror="this.src='assets/repuesto-default.png'">
      </div>
      <button mat-icon-button class="fav-btn"
              [color]="esFavorito(r.id) ? 'warn' : ''"
              (click)="toggleFavorito(r, $event)"
              [matTooltip]="esFavorito(r.id) ? 'Quitar de favoritos' : 'Agregar a favoritos'">
        <mat-icon>{{ esFavorito(r.id) ? 'favorite' : 'favorite_border' }}</mat-icon>
      </button>
    </div>

    <mat-card-content>
      <p style="color:#94a3b8;font-size:.78rem;margin-bottom:8px;font-family:monospace">{{ r.codigo }}</p>
      <p class="precio-tag">${{ r.precio | number:'1.2-2' }}</p>
      <p [class.stock-ok]="r.stock > 5"
         [class.stock-bajo]="r.stock > 0 && r.stock <= 5"
         [class.stock-agotado]="r.stock === 0">
        {{ r.stock > 0 ? 'En stock: ' + r.stock : 'Agotado' }}
      </p>
    </mat-card-content>

    <mat-card-actions style="display:flex;gap:8px;padding:8px 16px 16px">
      <button mat-stroked-button color="primary" routerLink="/repuesto/{{r.id}}" (click)="$event.stopPropagation()">
        Detalle
      </button>
      <button mat-raised-button color="primary"
              [disabled]="r.stock === 0"
              style="flex:1"
              (click)="$event.stopPropagation(); agregarAlCarrito(r)">
        <mat-icon style="font-size:18px">add_shopping_cart</mat-icon>
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<!-- Paginación -->
<div class="paginator-container" *ngIf="!cargando && totalItems > 0">
  <mat-paginator
    [length]="totalItems"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[6, 12, 24, 48]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>
</div>
